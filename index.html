<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Finance Master</title>

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpbmFuY2UgTWFzdGVyIiwKICAic2hvcnRfbmFtZSI6ICJGaW5hbmNlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwcz6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMTA1NDMvMTA1NDMyNjMucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAicHVycG9zZSI6ICJtYXNrYWJsZSIKICAgIH0KICBdCn0=">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* --- FINARY-LIKE DESIGN SYSTEM --- */
            --bg: #000000;
            --surface: #0f0f11;
            --surface-light: #1c1c1e;
            --primary: #0a84ff; /* iOS Blue */
            --accent: #5e5ce6;  /* Indigo */
            --text-main: #ffffff;
            --text-sec: #8e8e93;
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ffd60a;
            --border: 1px solid rgba(255,255,255,0.08);
            --radius: 16px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family:'Inter', sans-serif; user-select:none; }
        
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- TYPOGRAPHY --- */
        h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }
        .text-sm { font-size: 13px; color: var(--text-sec); font-weight: 500; }
        .amount { font-family: 'Inter', sans-serif; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }

        /* --- SCROLLABLE AREA --- */
        .app-content { 
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(100px + var(--safe-bottom));
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }

        /* --- HEADER --- */
        .header { 
            padding: calc(10px + var(--safe-top)) 20px 20px; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); 
            position: sticky; top: 0; z-index: 50; 
            border-bottom: var(--border);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .pill-pro { background: linear-gradient(135deg, #FFD60A, #FF9F0A); color: black; font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 800; box-shadow: 0 0 15px rgba(255, 214, 10, 0.3); }

        .net-worth-card { text-align: center; padding: 10px 0; }
        .nw-label { font-size: 11px; font-weight: 700; color: var(--text-sec); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
        .nw-value { font-size: 42px; font-weight: 800; letter-spacing: -1.5px; background: linear-gradient(180deg, #fff, #a1a1aa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nw-trend { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(48, 209, 88, 0.15); color: var(--success); font-size: 13px; font-weight: 600; border-radius: 20px; margin-top: 10px; }

        /* --- CARDS & LISTS --- */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 35px 0 15px; }
        .card { background: var(--surface); border: var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; position: relative; overflow: hidden; }
        
        .list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { opacity: 0.7; }
        
        .icon { width: 40px; height: 40px; border-radius: 12px; background: var(--surface-light); display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 16px; color: #fff; }
        .meta { flex: 1; }
        .meta-title { font-size: 15px; font-weight: 600; color: #fff; display: block; margin-bottom: 2px; }
        .meta-sub { font-size: 13px; color: var(--text-sec); }
        .meta-end { text-align: right; }
        .val { font-size: 15px; font-weight: 600; color: #fff; display: block; }
        .pct { font-size: 12px; font-weight: 500; }
        .green { color: var(--success); } .red { color: var(--danger); }

        /* --- BUTTONS --- */
        .btn-mini { width: 32px; height: 32px; border-radius: 10px; background: var(--surface-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 14px; border: var(--border); }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.97); }

        /* --- NAVIGATION --- */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); 
            border-top: var(--border); padding: 10px 20px calc(15px + var(--safe-bottom)); 
            display: flex; justify-content: space-between; z-index: 100; 
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sec); font-size: 10px; font-weight: 500; width: 60px; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active .nav-icon { transform: translateY(-2px); }

        /* --- MODALS (Sheet) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); 
            z-index: 200; display: none; align-items: flex-end; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .sheet { 
            background: #111; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1); 
            border-top: 1px solid rgba(255,255,255,0.15); max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.open .sheet { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: #333; border-radius: 2px; margin: 0 auto 25px; }

        /* --- INPUTS --- */
        .input-group { margin-bottom: 20px; }
        .label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .input { 
            width: 100%; padding: 16px; background: var(--surface-light); border: 1px solid transparent; 
            border-radius: 12px; color: white; font-size: 16px; outline: none; transition: 0.2s; 
        }
        .input:focus { border-color: var(--primary); background: #000; }
        select.input { appearance: none; }

        /* --- ONBOARDING --- */
        #onboarding { z-index: 999; background: #000; padding-top: 100px; text-align: center; }
        #onboarding .sheet { height: 100%; border-radius: 0; display: flex; flex-direction: column; justify-content: center; background: radial-gradient(circle at 50% 0%, #1c1c1e 0%, #000 100%); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .ad-space { background: #111; border: 1px dashed #333; padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 20px; font-size: 12px; color: #555; }
        
        /* --- TOGGLE --- */
        .toggle-row { display: flex; background: var(--surface-light); padding: 3px; border-radius: 10px; margin-bottom: 20px; }
        .toggle-opt { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; color: var(--text-sec); border-radius: 8px; transition: 0.2s; }
        .toggle-opt.active { background: #333; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .toggle-opt.active.inc { color: var(--success); }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="logo"><i class="fa-solid fa-layer-group" style="color:var(--primary)"></i> Finance Master</div>
            <div class="pill-pro hidden" id="proBadge">PRO</div>
            <div class="btn-mini" onclick="openModal('settings')"><i class="fa-solid fa-gear"></i></div>
        </div>
        <div class="net-worth-card">
            <div class="nw-label">Patrimoine Net</div>
            <div class="nw-value amount" id="totalWealth">0 €</div>
            <div class="nw-trend" id="trendBadge"><i class="fa-solid fa-arrow-trend-up"></i> +0.00%</div>
        </div>
    </div>

    <div class="app-content" id="mainContainer">
        
        <div id="view-home" class="view">
            <div class="ad-space" id="ad1">Publicité</div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:30px;">
                <button class="btn-main" style="margin:0; background:var(--surface-light); border:var(--border);" onclick="openModal('addAcc')">
                    <i class="fa-solid fa-wallet" style="margin-right:8px; color:var(--primary)"></i> Nouveau Compte
                </button>
                <button class="btn-main" style="margin:0; background:var(--surface-light); border:var(--border);" onclick="openModal('addTx')">
                    <i class="fa-solid fa-plus" style="margin-right:8px; color:var(--success)"></i> Transaction
                </button>
            </div>

            <div class="section-header">
                <h2>Mes Actifs</h2>
            </div>
            <div id="accountsList"></div>

            <div class="section-header">
                <h2>Historique</h2>
            </div>
            <div id="txList" class="card" style="min-height:100px; display:flex; align-items:center; justify-content:center; color:var(--text-sec);">Aucune transaction</div>
        </div>

        <div id="view-market" class="view hidden">
            <div class="input-group">
                <input type="text" class="input" placeholder="Rechercher (Bitcoin, Apple...)" oninput="filterMarket(this.value)">
            </div>
            <div id="marketList"></div>
        </div>

        <div id="view-stats" class="view hidden">
            <div class="card">
                <h3 style="margin-bottom:15px">Répartition</h3>
                <canvas id="chartDoughnut"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-bottom:15px">Evolution (6 mois)</h3>
                <canvas id="chartLine"></canvas>
            </div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="switchView('home', this)">
            <i class="fa-solid fa-house nav-icon"></i> Accueil
        </div>
        <div class="nav-btn" onclick="switchView('market', this)">
            <i class="fa-solid fa-chart-line nav-icon"></i> Marché
        </div>
        <div class="nav-btn" onclick="switchView('stats', this)">
            <i class="fa-solid fa-chart-pie nav-icon"></i> Stats
        </div>
    </div>

    <div id="onboarding" class="modal-overlay">
        <div class="sheet">
            <i class="fa-solid fa-shield-halved" style="font-size:60px; color:var(--primary); margin-bottom:20px;"></i>
            <h1 style="margin-bottom:10px;">Sécurisé & Privé</h1>
            <p style="color:var(--text-sec); margin-bottom:40px; font-size:14px; line-height:1.5;">Vos données sont stockées uniquement sur votre appareil. Commencez par configurer votre solde principal.</p>
            
            <div class="input-group">
                <label class="label">Nom de votre banque</label>
                <input id="initName" type="text" class="input" placeholder="Ex: Boursorama, Revolut...">
            </div>
            <div class="input-group">
                <label class="label">Solde actuel (€)</label>
                <input id="initBal" type="number" class="input" placeholder="0.00" style="font-size:24px; font-weight:700;">
            </div>
            <button class="btn-main" onclick="finishOnboarding()">Accéder à l'app</button>
        </div>
    </div>

    <div id="modal-addAcc" class="modal-overlay" onclick="closeModal(event, 'addAcc')">
        <div class="sheet">
            <div class="sheet-handle"></div>
            <h2 style="margin-bottom:20px">Ajouter un actif</h2>
            <div class="input-group">
                <label class="label">Type</label>
                <select id="accType" class="input">
                    <option value="bank">Compte Bancaire</option>
                    <option value="crypto">Portefeuille Crypto</option>
                    <option value="stock">Compte Titres / PEA</option>
                    <option value="real_estate">Immobilier</option>
                </select>
            </div>
            <div class="input-group"><label class="label">Nom</label><input id="accName" type="text" class="input"></div>
            <div class="input-group"><label class="label">Valeur (€)</label><input id="accBal" type="number" class="input"></div>
            <button class="btn-main" onclick="addAccount()">Créer</button>
        </div>
    </div>

    <div id="modal-addTx" class="modal-overlay" onclick="closeModal(event, 'addTx')">
        <div class="sheet">
            <div class="sheet-handle"></div>
            <h2 style="margin-bottom:20px">Nouvelle opération</h2>
            <div class="toggle-row">
                <div class="toggle-opt active" id="opt-expense" onclick="setTxType('expense')">Dépense</div>
                <div class="toggle-opt" id="opt-income" onclick="setTxType('income')">Revenu</div>
            </div>
            <div class="input-group"><label class="label">Montant</label><input id="txAmount" type="number" class="input" style="font-size:24px; font-weight:700;"></div>
            <div class="input-group"><label class="label">Catégorie</label><input id="txCat" type="text" class="input" list="cats"><datalist id="cats"><option value="Courses"><option value="Loyer"><option value="Salaire"></datalist></div>
            <button class="btn-main" onclick="addTransaction()">Valider</button>
        </div>
    </div>

    <div id="modal-settings" class="modal-overlay" onclick="closeModal(event, 'settings')">
        <div class="sheet">
            <div class="sheet-handle"></div>
            <h2 style="margin-bottom:20px">Paramètres</h2>
            
            <div class="card" onclick="triggerImport()" style="display:flex; align-items:center; padding:20px;">
                <i class="fa-solid fa-file-import" style="margin-right:15px; font-size:20px;"></i>
                <div>
                    <span style="display:block; font-weight:600;">Importer CSV</span>
                    <span class="text-sm">Relevé bancaire</span>
                </div>
            </div>
            <input type="file" id="fileInput" hidden onchange="processCSV(event)">

            <div class="card" onclick="exportData()" style="display:flex; align-items:center; padding:20px;">
                <i class="fa-solid fa-download" style="margin-right:15px; font-size:20px;"></i>
                <div>
                    <span style="display:block; font-weight:600;">Sauvegarde</span>
                    <span class="text-sm">Exporter en JSON</span>
                </div>
            </div>

            <div class="card" style="background:rgba(255,214,10,0.1); border-color:#FFD60A; text-align:center;">
                <h3 style="color:#FFD60A; margin-bottom:5px;">Version PRO</h3>
                <p class="text-sm" style="margin-bottom:15px;">Graphiques illimités & Sans Pubs</p>
                <button class="btn-main" style="margin:0; background:#FFD60A; color:black;" onclick="activatePro()">Activer (Gratuit ajd)</button>
            </div>

            <div style="text-align:center; margin-top:30px;">
                <button style="background:none; border:none; color:var(--danger); font-weight:600;" onclick="hardReset()">Réinitialiser l'application</button>
                <div class="text-sm" style="margin-top:10px; opacity:0.5;">v20.0 • Build Final</div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC CORE (V20) ---
        const APP_KEY = 'finance_master_v20';
        let db = { accounts: [], transactions: [], user: { pro: false, currency: 'EUR' } };
        let marketData = [];
        let txType = 'expense';
        
        // MOCK MARKET DATA (Fail-safe)
        const MOCK_MARKET = [
            { id: 'bitcoin', name: 'Bitcoin', symbol: 'BTC', price: 42350, change: 1.25, img: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png' },
            { id: 'ethereum', name: 'Ethereum', symbol: 'ETH', price: 2280, change: -0.45, img: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png' },
            { id: 'solana', name: 'Solana', symbol: 'SOL', price: 98.50, change: 5.12, img: 'https://assets.coingecko.com/coins/images/4128/large/solana.png' },
            { id: 'apple', name: 'Apple Inc', symbol: 'AAPL', price: 185.40, change: 0.80, img: 'https://cdn-icons-png.flaticon.com/512/732/732221.png' },
            { id: 'tesla', name: 'Tesla', symbol: 'TSLA', price: 215.30, change: -2.10, img: 'https://cdn-icons-png.flaticon.com/512/5969/5969049.png' }
        ];

        // INIT
        window.onload = () => {
            // Check LocalStorage
            const saved = localStorage.getItem(APP_KEY);
            if (saved) {
                db = JSON.parse(saved);
                renderUI();
                fetchMarket();
            } else {
                // Show Onboarding
                document.getElementById('onboarding').classList.add('open');
            }
        };

        function saveData() {
            localStorage.setItem(APP_KEY, JSON.stringify(db));
            renderUI();
        }

        // ONBOARDING
        function finishOnboarding() {
            const name = document.getElementById('initName').value;
            const bal = parseFloat(document.getElementById('initBal').value);
            
            if (name && !isNaN(bal)) {
                db.accounts.push({ id: Date.now(), name: name, type: 'bank', balance: bal });
                saveData();
                document.getElementById('onboarding').classList.remove('open');
                fetchMarket(); // Start fetching data
            } else {
                alert("Veuillez entrer des informations valides.");
            }
        }

        // UI RENDERER
        function renderUI() {
            // 1. Total Wealth
            const total = db.accounts.reduce((sum, acc) => sum + acc.balance, 0);
            document.getElementById('totalWealth').innerText = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(total);
            
            // 2. Accounts List
            const list = document.getElementById('accountsList');
            if (db.accounts.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:var(--text-sec); padding:20px;">Aucun compte</div>';
            } else {
                list.innerHTML = db.accounts.map(acc => `
                    <div class="card list-item">
                        <div class="icon" style="color:${getColor(acc.type)}"><i class="fa-solid ${getIcon(acc.type)}"></i></div>
                        <div class="meta">
                            <span class="meta-title">${acc.name}</span>
                            <span class="meta-sub">${getTypeName(acc.type)}</span>
                        </div>
                        <div class="val">${new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(acc.balance)}</div>
                    </div>
                `).join('');
            }

            // 3. Transactions List
            const txContainer = document.getElementById('txList');
            if (db.transactions.length === 0) {
                txContainer.innerHTML = 'Aucune transaction récente';
                txContainer.style.display = 'flex'; // Restore center alignment
            } else {
                txContainer.style.display = 'block'; // Allow list layout
                txContainer.innerHTML = db.transactions.slice().reverse().slice(0, 5).map(tx => `
                    <div class="list-item" style="border-bottom:1px solid rgba(255,255,255,0.05);">
                        <div class="icon" style="width:36px; height:36px; font-size:14px; margin-right:12px;">
                            <i class="fa-solid ${tx.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'}" style="color:${tx.type === 'income' ? 'var(--success)' : 'var(--text-main)'}"></i>
                        </div>
                        <div class="meta">
                            <span class="meta-title" style="font-size:14px;">${tx.category}</span>
                            <span class="meta-sub">${new Date(tx.date).toLocaleDateString()}</span>
                        </div>
                        <div class="val ${tx.type === 'income' ? 'green' : ''}">${tx.type === 'income' ? '+' : '-'}${tx.amount} €</div>
                    </div>
                `).join('');
            }

            // 4. Pro Status
            if (db.user.pro) {
                document.getElementById('ad1').style.display = 'none';
                document.querySelector('.pill-pro').classList.remove('hidden');
            }
        }

        // MARKET ENGINE (FAIL-SAFE)
        async function fetchMarket() {
            const list = document.getElementById('marketList');
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec);">Chargement des cours...</div>';
            
            try {
                // Try fetching CoinGecko
                const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=eur&ids=bitcoin,ethereum,solana,binancecoin,ripple,cardano&sparkline=false');
                if (!res.ok) throw new Error("API Limit");
                const data = await res.json();
                
                // Map API data to our format
                marketData = data.map(c => ({
                    id: c.id, name: c.name, symbol: c.symbol.toUpperCase(), 
                    price: c.current_price, change: c.price_change_percentage_24h, img: c.image
                }));
                
                // Add Stock Mocks
                marketData.push(...MOCK_MARKET.slice(3)); // Add Apple & Tesla mocks
                
            } catch (e) {
                console.warn("Market API failed, using Mocks.");
                marketData = MOCK_MARKET;
            }
            
            renderMarket(marketData);
        }

        function renderMarket(data) {
            const list = document.getElementById('marketList');
            list.innerHTML = data.map(item => `
                <div class="card list-item">
                    <img src="${item.img}" style="width:36px; height:36px; border-radius:50%; margin-right:15px;">
                    <div class="meta">
                        <span class="meta-title">${item.symbol}</span>
                        <span class="meta-sub">${item.name}</span>
                    </div>
                    <div class="meta-end">
                        <span class="val">${item.price.toLocaleString()} €</span>
                        <span class="pct ${item.change >= 0 ? 'green' : 'red'}">${item.change > 0 ? '+' : ''}${item.change.toFixed(2)}%</span>
                    </div>
                </div>
            `).join('');
        }

        function filterMarket(query) {
            const q = query.toLowerCase();
            const filtered = marketData.filter(i => i.name.toLowerCase().includes(q) || i.symbol.toLowerCase().includes(q));
            renderMarket(filtered);
        }

        // ACTIONS
        function addAccount() {
            const name = document.getElementById('accName').value;
            const bal = parseFloat(document.getElementById('accBal').value);
            const type = document.getElementById('accType').value;
            
            if (name && !isNaN(bal)) {
                db.accounts.push({ id: Date.now(), name, type, balance: bal });
                saveData();
                closeModal(null, 'addAcc');
            }
        }

        function setTxType(type) {
            txType = type;
            document.getElementById('opt-expense').className = type === 'expense' ? 'toggle-opt active' : 'toggle-opt';
            document.getElementById('opt-income').className = type === 'income' ? 'toggle-opt active inc' : 'toggle-opt';
        }

        function addTransaction() {
            const amt = parseFloat(document.getElementById('txAmount').value);
            const cat = document.getElementById('txCat').value;
            
            if (!isNaN(amt) && cat) {
                db.transactions.push({ id: Date.now(), amount: amt, type: txType, category: cat, date: new Date() });
                
                // Update Balance of first account logic (Simplified for UX)
                if (db.accounts.length > 0) {
                    db.accounts[0].balance += (txType === 'income' ? amt : -amt);
                }
                
                saveData();
                closeModal(null, 'addTx');
            }
        }

        // CSV IMPORT (Real Feature)
        function triggerImport() { document.getElementById('fileInput').click(); }
        function processCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                let count = 0;
                lines.forEach(line => {
                    // Simple parser expecting: Date;Category;Amount
                    const parts = line.split(';');
                    if (parts.length >= 3) {
                        const amt = parseFloat(parts[2]);
                        if (!isNaN(amt)) {
                            db.transactions.push({
                                id: Date.now() + Math.random(),
                                date: new Date(),
                                category: parts[1] || 'Import',
                                amount: Math.abs(amt),
                                type: amt >= 0 ? 'income' : 'expense'
                            });
                            count++;
                        }
                    }
                });
                if(count > 0 && db.accounts.length > 0) {
                    // Re-calculate balance based on import (Approximation)
                    // In a real app, we would ask which account to link
                }
                saveData();
                alert(count + " opérations importées !");
            };
            reader.readAsText(file);
        }

        // HELPERS
        function getIcon(t) { return {bank:'fa-building-columns', crypto:'fa-bitcoin', stock:'fa-chart-line', real_estate:'fa-house'}[t] || 'fa-wallet'; }
        function getColor(t) { return {bank:'#0a84ff', crypto:'#5e5ce6', stock:'#30d158', real_estate:'#ffd60a'}[t] || '#fff'; }
        function getTypeName(t) { return {bank:'Banque', crypto:'Crypto', stock:'Bourse', real_estate:'Immobilier'}[t]; }

        function switchView(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-'+viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            
            if(viewId === 'stats') renderCharts();
        }

        function openModal(id) { document.getElementById('modal-'+id).classList.add('open'); }
        function closeModal(e, id) { 
            if (!e || e.target.id === 'modal-'+id) document.getElementById('modal-'+id).classList.remove('open'); 
        }

        function activatePro() {
            db.user.pro = true;
            saveData();
            closeModal(null, 'settings');
            alert("Mode PRO activé !");
        }

        function hardReset() {
            if (confirm("Effacer toutes les données ?")) {
                localStorage.removeItem(APP_KEY);
                location.reload();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "finance_backup.json");
            document.body.appendChild(node); node.click(); node.remove();
        }

        // CHARTS
        function renderCharts() {
            const ctx1 = document.getElementById('chartDoughnut');
            const expenses = {};
            db.transactions.filter(t => t.type === 'expense').forEach(t => {
                expenses[t.category] = (expenses[t.category] || 0) + t.amount;
            });

            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenses),
                    datasets: [{
                        data: Object.values(expenses),
                        backgroundColor: ['#0a84ff', '#5e5ce6', '#30d158', '#ff453a', '#ffd60a'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'right', labels: { color: '#888' } } } }
            });
        }

    </script>
</body>
</html>
