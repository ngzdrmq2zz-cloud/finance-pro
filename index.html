<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Finance Master Pro</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpbmFuY2UgTWFzdGVyIFBybyIsCiAgInNob3J0X25hbWUiOiAiRmluYW5jZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzJhIiwKICAidGhlbWVfY29sb3IiOiAiIzFhMmUzYSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjkxMC8yOTEwNzk1LnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwcz6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjkxMC8yOTEwNzk1LnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">

    <style>
        :root {
            --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --text-light: #64748b;
            --success: #10b981; --danger: #ef4444; --gold: #fbbf24;
            --shadow: 0 4px 20px rgba(0,0,0,0.05); --radius: 20px;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-light: #94a3b8; }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 100px; min-height: 100vh; }

        /* HEADER */
        .header { background: linear-gradient(135deg, var(--primary), #4338ca); padding: 20px 20px 80px; color: white; border-radius: 0 0 30px 30px; box-shadow: 0 10px 30px -10px var(--primary); }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .logo span { background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 8px; font-size: 12px; }
        .balance-card { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); padding: 24px; border-radius: 24px; box-shadow: 0 15px 30px rgba(0,0,0,0.15); margin-top: -10px; }
        .balance-title { font-size: 12px; text-transform: uppercase; opacity: 0.8; letter-spacing: 1px; font-weight: 600; }
        .balance-amount { font-size: 36px; font-weight: 800; margin: 8px 0; letter-spacing: -1px; }

        /* CONTAINER */
        .container { padding: 0 20px; margin-top: 20px; }
        .section-title { font-size: 18px; font-weight: 700; margin: 30px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .card { background: var(--card); padding: 16px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .card:active { transform: scale(0.98); }
        
        .btn-add { background: var(--text); color: var(--bg); width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; border: none; }
        
        /* NAVIGATION */
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--card); padding: 12px 20px; border-radius: 24px; display: flex; justify-content: space-between; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2); z-index: 100; border: 1px solid rgba(128,128,128,0.1); }
        .nav-item { font-size: 24px; opacity: 0.5; transition: 0.3s; cursor: pointer; padding: 5px; }
        .nav-item.active { opacity: 1; transform: translateY(-3px); border-bottom: 2px solid var(--primary); }

        /* VUES */
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* PUBS & PREMIUM */
        .ad-banner { background: var(--card); padding: 16px; border-radius: 16px; border: 1px dashed var(--text-light); text-align: center; margin-bottom: 20px; }
        .premium-badge { display: none; background: var(--gold); color: black; font-weight: 800; padding: 2px 8px; border-radius: 10px; font-size: 10px; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; w: 100%; h: 100%; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; }
        .modal.open { display: flex; }
        .modal-content { background: var(--card); width: 100%; border-radius: 24px 24px 0 0; padding: 30px 20px 50px; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .input { width: 100%; padding: 16px; background: var(--bg); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; margin-bottom: 12px; font-size: 16px; color: var(--text); outline: none; }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; }
        
        /* MARKET */
        .chip-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .chip { padding: 8px 16px; background: var(--card); border-radius: 20px; font-weight: 600; font-size: 13px; color: var(--text-light); border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; }
        .chip.active { background: var(--text); color: var(--bg); }
    </style>
</head>
<body>

    <div class="header">
        <div class="top-nav">
            <div class="logo">üí∞ Finance <span id="proBadge" class="premium-badge">PRO</span></div>
            <div style="font-size:24px; cursor:pointer;" onclick="switchView('settings')">‚öôÔ∏è</div>
        </div>
        <div class="balance-card">
            <div class="balance-title">Patrimoine Total</div>
            <div class="balance-amount" id="totalBalance">0,00 ‚Ç¨</div>
            <div style="font-size:13px; opacity:0.8" id="balanceCount">Chargement...</div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('dashboard', this)">üè†</div>
        <div class="nav-item" onclick="switchView('market', this)">üìà</div>
        <div class="nav-item" onclick="switchView('stats', this)">üìä</div>
        <div class="nav-item" onclick="switchView('settings', this)">‚öôÔ∏è</div>
    </div>

    <div class="container">
        
        <div id="dashboardView" class="view active">
            <div class="ad-banner" id="ad1">
                <div style="font-size:10px; text-transform:uppercase; margin-bottom:5px; opacity:0.5">Publicit√©</div>
                üì¢ Espace Pub Google Ads
            </div>

            <div class="section-title">
                Comptes
                <button class="btn-add" onclick="openModal('modalAccount')">+</button>
            </div>
            <div id="accountsList">
                <div style="text-align:center; padding:20px; opacity:0.5;">Aucun compte. Cliquez sur +</div>
            </div>

            <div class="section-title">
                Transactions
                <button class="btn-add" onclick="openModal('modalTransaction')">+</button>
            </div>
            <div id="transactionsList"></div>
        </div>

        <div id="marketView" class="view">
            <div class="chip-container">
                <div class="chip active" onclick="filterMarket('all', this)">Tout</div>
                <div class="chip" onclick="filterMarket('crypto', this)">Cryptos</div>
                <div class="chip" onclick="filterMarket('stock', this)">Bourse</div>
            </div>
            <div class="ad-banner" id="ad2">üì¢ Trading sans frais</div>
            <div id="marketList">Chargement des cours...</div>
        </div>

        <div id="statsView" class="view">
            <div class="section-title">Analyse</div>
            <div class="card" style="display:block">
                <div id="chart" style="height:30px; background:#eee; border-radius:10px; display:flex; overflow:hidden;"></div>
                <div id="legend" style="margin-top:10px; font-size:12px;"></div>
            </div>
        </div>

        <div id="settingsView" class="view">
            <div class="section-title">Pr√©f√©rences</div>
            <div class="card">
                <b>Devise</b>
                <select id="currencySelect" style="border:none; background:transparent; font-weight:bold;" onchange="changeCurrency(this.value)">
                    <option value="EUR">EUR (‚Ç¨)</option>
                    <option value="USD">USD ($)</option>
                </select>
            </div>
            
            <div class="card" id="premiumBox" style="background:#fffbeb; border:1px solid #fbbf24; display:block;">
                <div style="color:#b45309; font-weight:800; font-size:18px;">üíé Mode PRO</div>
                <div style="color:#b45309; font-size:13px; margin:5px 0 15px;">Supprimez les pubs √† vie.</div>
                <button class="btn-main" style="background:#d97706" onclick="openModal('modalPay')">Payer 5,00 ‚Ç¨</button>
            </div>

            <div style="text-align:center; margin-top:30px;">
                <button onclick="hardReset()" style="color:red; background:none; border:none; font-weight:bold;">‚ö†Ô∏è R√©initialiser l'App</button>
            </div>
        </div>

    </div>

    <div id="modalAccount" class="modal" onclick="closeModal(event, 'modalAccount')">
        <div class="modal-content">
            <h2>Nouveau Compte</h2><br>
            <select id="accType" class="input"><option value="bank">üè¶ Banque</option><option value="crypto">‚Çø Crypto</option><option value="stock">üìà Bourse</option></select>
            <input type="text" id="accName" class="input" placeholder="Nom (ex: Boursorama)">
            <input type="number" id="accBal" class="input" placeholder="Montant (ex: 1500)">
            <button class="btn-main" onclick="addAccount()">Ajouter</button>
        </div>
    </div>

    <div id="modalTransaction" class="modal" onclick="closeModal(event, 'modalTransaction')">
        <div class="modal-content">
            <h2>Nouvelle Transaction</h2><br>
            <select id="txType" class="input"><option value="expense">üìâ D√©pense</option><option value="income">üìà Revenu</option></select>
            <input type="number" id="txAmount" class="input" placeholder="Montant">
            <input type="text" id="txCat" class="input" placeholder="Cat√©gorie (Loyer, Salaire...)">
            <button class="btn-main" onclick="addTransaction()">Valider</button>
        </div>
    </div>

    <div id="modalPay" class="modal" onclick="closeModal(event, 'modalPay')">
        <div class="modal-content" style="text-align:center;">
            <div style="font-size:50px">üíé</div>
            <h2>Finance Master PRO</h2>
            <p style="opacity:0.6; margin-bottom:20px;">Paiement s√©curis√© (Simulation)</p>
            <button class="btn-main" style="background:black" onclick="processPayment()">Ô£ø Apple Pay</button>
        </div>
    </div>

    <script>
        // --- 1. SYSTEME DE DONNEES & NETTOYAGE AUTO ---
        const APP_VERSION = '6.0'; // Nouvelle version
        
        let state = { accounts: [], transactions: [], currency: 'EUR', isPremium: false };

        function initApp() {
            // V√©rification de version pour √©viter le bug "Rien ne marche"
            const storedVersion = localStorage.getItem('app_version');
            if (storedVersion !== APP_VERSION) {
                console.log("Mise √† jour d√©tect√©e : Nettoyage des anciennes donn√©es...");
                localStorage.clear();
                localStorage.setItem('app_version', APP_VERSION);
            } else {
                // Chargement normal
                if(localStorage.getItem('state')) {
                    try {
                        state = JSON.parse(localStorage.getItem('state'));
                    } catch(e) { localStorage.clear(); }
                }
            }

            // Initialisation UI
            updateUI();
            checkPremium();
            
            // Chargement March√© (Async)
            setTimeout(loadMarket, 500);
        }

        function save() {
            localStorage.setItem('state', JSON.stringify(state));
            updateUI();
        }

        function updateUI() {
            // Total
            const total = state.accounts.reduce((sum, a) => sum + parseFloat(a.balance), 0);
            document.getElementById('totalBalance').innerText = total.toLocaleString() + " " + (state.currency == 'EUR' ? '‚Ç¨' : '$');
            document.getElementById('balanceCount').innerText = `${state.accounts.length} comptes actifs`;

            // Comptes
            const accList = document.getElementById('accountsList');
            if(state.accounts.length > 0) {
                accList.innerHTML = state.accounts.map(a => `
                    <div class="card">
                        <div><b>${a.name}</b><br><small style="opacity:0.5">${a.type == 'crypto' ? 'Crypto' : 'Banque'}</small></div>
                        <b>${parseFloat(a.balance).toLocaleString()}</b>
                    </div>
                `).join('');
            }

            // Transactions
            const txList = document.getElementById('transactionsList');
            if(state.transactions.length > 0) {
                txList.innerHTML = state.transactions.slice().reverse().slice(0, 5).map(t => `
                    <div class="card" style="padding:12px;">
                        <div>${t.category}</div>
                        <b style="color:${t.type=='income'?'#10b981':'#ef4444'}">${t.type=='income'?'+':'-'}${t.amount}</b>
                    </div>
                `).join('');
            } else {
                txList.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">Aucune transaction</div>';
            }

            // Stats
            renderStats();
        }

        // --- 2. FONCTIONNALITES ---
        
        function switchView(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + 'View').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(e, id) { if(e.target.id == id) document.getElementById(id).classList.remove('open'); }

        function addAccount() {
            const name = document.getElementById('accName').value;
            const bal = document.getElementById('accBal').value;
            if(name && bal) {
                state.accounts.push({ name, balance: bal, type: document.getElementById('accType').value });
                save();
                document.getElementById('modalAccount').classList.remove('open');
            }
        }

        function addTransaction() {
            const amt = parseFloat(document.getElementById('txAmount').value);
            const cat = document.getElementById('txCat').value;
            const type = document.getElementById('txType').value;
            
            if(amt && cat) {
                state.transactions.push({ amount: amt, category: cat, type, date: new Date() });
                // Mise √† jour du premier compte trouv√© (Simplifi√©)
                if(state.accounts.length > 0) {
                    let acc = state.accounts[0];
                    acc.balance = parseFloat(acc.balance) + (type == 'income' ? amt : -amt);
                }
                save();
                document.getElementById('modalTransaction').classList.remove('open');
            }
        }

        function checkPremium() {
            const ads = document.querySelectorAll('.ad-banner');
            const badge = document.getElementById('proBadge');
            const box = document.getElementById('premiumBox');
            
            if(state.isPremium) {
                ads.forEach(ad => ad.style.display = 'none');
                badge.style.display = 'inline-block';
                box.innerHTML = '<b style="color:green">‚úÖ Compte PRO Actif</b>';
                box.style.background = '#dcfce7';
                box.style.borderColor = 'green';
            } else {
                ads.forEach(ad => ad.style.display = 'block');
                badge.style.display = 'none';
            }
        }

        function processPayment() {
            if(confirm("Confirmer le paiement de 5,00 ‚Ç¨ ?")) {
                state.isPremium = true;
                save();
                checkPremium();
                document.getElementById('modalPay').classList.remove('open');
                alert("Bienvenue membre PRO !");
            }
        }

        function hardReset() {
            if(confirm("Tout effacer ?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- 3. MARKET & STATS ---
        
        async function loadMarket() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=eur&ids=bitcoin,ethereum,solana&sparkline=false');
                const data = await res.json();
                state.marketData = data;
                renderMarket(data);
            } catch(e) {
                document.getElementById('marketList').innerHTML = "Erreur chargement. V√©rifiez connexion.";
            }
        }

        function renderMarket(data) {
            document.getElementById('marketList').innerHTML = data.map(coin => `
                <div class="card">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${coin.image}" style="width:30px; height:30px; border-radius:50%">
                        <b>${coin.name}</b>
                    </div>
                    <div>
                        <b>${coin.current_price} ‚Ç¨</b>
                        <div style="font-size:12px; color:${coin.price_change_percentage_24h >= 0 ? 'green' : 'red'}">
                            ${coin.price_change_percentage_24h.toFixed(2)}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterMarket(type, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            if(type == 'all' || type == 'crypto') renderMarket(state.marketData || []);
            else document.getElementById('marketList').innerHTML = '<div class="card"><b>Apple (AAPL)</b> 185.00 $</div>'; // Simulation Stock
        }

        function renderStats() {
            const chart = document.getElementById('chart');
            const legend = document.getElementById('legend');
            
            // Calcul simple
            let totals = {};
            let totalExp = 0;
            state.transactions.filter(t => t.type == 'expense').forEach(t => {
                totals[t.category] = (totals[t.category] || 0) + t.amount;
                totalExp += t.amount;
            });

            if(totalExp == 0) {
                chart.innerHTML = '';
                legend.innerHTML = 'Pas assez de donn√©es';
                return;
            }

            const colors = ['#ef4444', '#f59e0b', '#3b82f6'];
            let html = '';
            let legHtml = '';
            let i = 0;

            for(let cat in totals) {
                let pct = (totals[cat] / totalExp) * 100;
                let color = colors[i % 3];
                html += `<div style="width:${pct}%; background:${color}"></div>`;
                legHtml += `<span style="margin-right:10px; color:${color}">‚óè ${cat} ${Math.round(pct)}%</span>`;
                i++;
            }
            chart.innerHTML = html;
            legend.innerHTML = legHtml;
        }

        // Lancement
        initApp();

    </script>
</body>
</html>
