<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Finance Pro</title>
    
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --gray: #64748b;
            --safe-pb: env(safe-area-inset-bottom);
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --gray: #94a3b8; }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 0; }
        
        body { background: var(--bg); color: var(--text); padding-bottom: calc(90px + var(--safe-pb)); user-select: none; }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary), #4338ca);
            padding: 20px 20px 80px;
            color: white;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 10px 30px -10px var(--primary);
        }
        .top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-weight: 900; font-size: 20px; display: flex; align-items: center; gap: 8px; }
        .pro-tag { background: #fbbf24; color: black; font-size: 10px; padding: 2px 6px; border-radius: 4px; display: none; }
        
        .balance-box {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 20px;
        }
        .balance-val { font-size: 34px; font-weight: 800; margin: 5px 0; }

        /* CONTAINER */
        .container { padding: 0 20px; margin-top: -50px; position: relative; z-index: 10; }
        
        /* CARDS */
        .card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .section-title { font-weight: 700; margin: 25px 0 10px; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn-add { background: var(--text); color: var(--bg); width: 28px; height: 28px; border-radius: 8px; border: none; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* LISTS */
        .row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .row:last-child { border: none; }
        .icon { width: 40px; height: 40px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px; }
        .info b { display: block; font-size: 15px; }
        .info span { font-size: 12px; color: var(--gray); }
        
        /* NAV */
        .nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: var(--card); padding: 10px 20px; border-radius: 20px;
            display: flex; justify-content: space-between;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100;
        }
        .nav-item { font-size: 22px; opacity: 0.4; padding: 8px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { opacity: 1; transform: translateY(-3px); color: var(--primary); }

        /* VIEWS */
        .view { display: none; }
        .view.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* MODAL */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; }
        .modal-bg.open { display: flex; }
        .modal { background: var(--card); width: 100%; padding: 25px; border-radius: 25px 25px 0 0; animation: slide 0.3s; }
        @keyframes slide { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .inp { width: 100%; padding: 14px; background: var(--bg); border: none; border-radius: 12px; margin-bottom: 12px; font-size: 16px; color: var(--text); }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; font-weight: 700; border-radius: 12px; border: none; font-size: 16px; margin-top: 10px; }

        /* MARKET & STATS */
        .chip-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .chip { padding: 6px 12px; background: var(--card); border: 1px solid var(--gray); border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .chip.active { background: var(--text); color: var(--bg); border-color: var(--text); }
        
        .bar-chart { display: flex; height: 100px; align-items: flex-end; gap: 4px; margin-top: 20px; }
        .bar { flex: 1; background: var(--primary); border-radius: 4px 4px 0 0; opacity: 0.7; }
        
        /* AD */
        .ad { background: var(--card); border: 1px dashed var(--gray); padding: 15px; text-align: center; border-radius: 16px; margin-bottom: 20px; font-size: 12px; color: var(--gray); }
    </style>
</head>
<body>

    <div class="header">
        <div class="top">
            <div class="logo">üíé Finance <span id="pro" class="pro-tag">PRO</span></div>
            <div onclick="switchView('settings')" style="cursor:pointer">‚öôÔ∏è</div>
        </div>
        <div class="balance-box">
            <div style="font-size:12px; opacity:0.8">PATRIMOINE</div>
            <div class="balance-val" id="totalBalance">0 ‚Ç¨</div>
            <div style="font-size:13px; opacity:0.8" id="accCount">---</div>
        </div>
    </div>

    <div class="container">
        <div id="view-home" class="view active">
            <div class="ad" id="ad1">PUBLICIT√â GOOGLE ADS</div>
            
            <div class="section-title">Comptes <button class="btn-add" onclick="openModal('acc')">+</button></div>
            <div id="list-acc"></div>

            <div class="section-title">Op√©rations <button class="btn-add" onclick="openModal('tx')">+</button></div>
            <div id="list-tx" class="card" style="text-align:center; padding:30px; opacity:0.5">Aucune donn√©e</div>
        </div>

        <div id="view-budget" class="view">
            <div class="section-title">Budgets <button class="btn-add" onclick="openModal('bud')">+</button></div>
            <div id="list-budget"></div>
            
            <div class="section-title">Objectifs <button class="btn-add" onclick="openModal('goal')">+</button></div>
            <div id="list-goal"></div>
        </div>

        <div id="view-market" class="view">
            <div class="chip-scroll">
                <div class="chip active" onclick="loadMarket('all')">Tout</div>
                <div class="chip" onclick="loadMarket('crypto')">Crypto</div>
                <div class="chip" onclick="loadMarket('stock')">Actions</div>
            </div>
            <div class="ad" id="ad2">OFFRE TRADING SPONSORIS√âE</div>
            <input type="text" class="inp" placeholder="Rechercher..." oninput="searchMarket(this.value)" style="margin-top:10px">
            <div id="list-market" style="margin-top:10px">Chargement...</div>
        </div>

        <div id="view-stats" class="view">
            <div class="section-title">D√©penses par cat√©gorie</div>
            <div class="card">
                <div id="stats-bars" class="bar-chart"></div>
                <div id="stats-legend" style="margin-top:10px; font-size:12px"></div>
            </div>
        </div>

        <div id="view-settings" class="view">
            <div class="section-title">Options</div>
            <div class="card">
                <p style="margin-bottom:5px"><b>Devise</b></p>
                <select id="currency" class="inp" onchange="setCurrency(this.value)" style="margin:0">
                    <option value="EUR">EUR (‚Ç¨)</option>
                    <option value="USD">USD ($)</option>
                </select>
            </div>
            
            <div class="card" style="background:#fffbeb; border:1px solid #fbbf24; text-align:center" id="premium-offer">
                <h2 style="color:#b45309">üíé Passer PRO</h2>
                <p style="font-size:12px; color:#b45309; margin:10px 0">Supprimez les pubs √† vie.</p>
                <button class="btn-main" style="background:#d97706" onclick="openModal('pay')">Payer 5,00 ‚Ç¨</button>
            </div>

            <div style="text-align:center; margin-top:30px">
                <button onclick="resetAll()" style="background:none; border:none; color:red; font-weight:bold">Tout effacer</button>
                <div style="font-size:10px; margin-top:10px; opacity:0.5">v9.5 Secure</div>
            </div>
        </div>
    </div>

    <div id="modal-acc" class="modal-bg" onclick="closeModal(event, 'acc')">
        <div class="modal">
            <h3>Ajouter Compte</h3>
            <select id="acc-type" class="inp" style="margin-top:10px"><option value="bank">Banque</option><option value="crypto">Crypto</option><option value="stock">Bourse</option></select>
            <input id="acc-name" type="text" class="inp" placeholder="Nom">
            <input id="acc-bal" type="number" class="inp" placeholder="Solde">
            <button class="btn-main" onclick="addAcc()">Valider</button>
        </div>
    </div>

    <div id="modal-tx" class="modal-bg" onclick="closeModal(event, 'tx')">
        <div class="modal">
            <h3>Transaction</h3>
            <div style="display:flex; gap:10px; margin-top:10px">
                <select id="tx-type" class="inp"><option value="expense">D√©pense</option><option value="income">Revenu</option></select>
            </div>
            <input id="tx-amt" type="number" class="inp" placeholder="Montant">
            <input id="tx-cat" type="text" class="inp" placeholder="Cat√©gorie (Loyer...)" list="cats">
            <datalist id="cats"><option value="Alimentation"><option value="Transport"><option value="Logement"></datalist>
            <button class="btn-main" onclick="addTx()">Valider</button>
        </div>
    </div>

    <div id="modal-bud" class="modal-bg" onclick="closeModal(event, 'bud')">
        <div class="modal">
            <h3>Nouveau Budget</h3>
            <input id="bud-cat" type="text" class="inp" placeholder="Cat√©gorie" list="cats" style="margin-top:10px">
            <input id="bud-lim" type="number" class="inp" placeholder="Limite">
            <button class="btn-main" onclick="addBudget()">Cr√©er</button>
        </div>
    </div>

    <div id="modal-goal" class="modal-bg" onclick="closeModal(event, 'goal')">
        <div class="modal">
            <h3>Objectif √âpargne</h3>
            <input id="goal-name" type="text" class="inp" placeholder="Nom (Voyage...)" style="margin-top:10px">
            <input id="goal-target" type="number" class="inp" placeholder="Cible">
            <input id="goal-cur" type="number" class="inp" placeholder="D√©j√† √©pargn√©">
            <button class="btn-main" onclick="addGoal()">Cr√©er</button>
        </div>
    </div>

    <div id="modal-pay" class="modal-bg" onclick="closeModal(event, 'pay')">
        <div class="modal" style="text-align:center">
            <div style="font-size:40px">üíé</div>
            <h3>Finance Pro</h3>
            <p style="margin-bottom:20px; opacity:0.6">Simulation de paiement</p>
            <button class="btn-main" style="background:black" onclick="pay()">Ô£ø Apple Pay</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="go('home',this)">üè†</div>
        <div class="nav-item" onclick="go('budget',this)">üìä</div>
        <div class="nav-item" onclick="go('market',this)">üìà</div>
        <div class="nav-item" onclick="go('stats',this)">ü•ß</div>
        <div class="nav-item" onclick="go('settings',this)">‚öôÔ∏è</div>
    </div>

    <script>
        // --- DATA ---
        let d = { acc:[], tx:[], bud:[], goal:[], cur:'EUR', pro:false };
        let market = [];

        // --- INIT ---
        window.onload = () => {
            try {
                if(localStorage.getItem('fin_data')) d = JSON.parse(localStorage.getItem('fin_data'));
            } catch(e) { localStorage.clear(); } // Reset auto si corrompu
            
            render();
            checkPro();
            setTimeout(getMarket, 100); // Chargement march√©
        };

        function save() { localStorage.setItem('fin_data', JSON.stringify(d)); render(); }
        function fmt(n) { return (parseFloat(n)*(d.cur=='USD'?1.08:1)).toLocaleString('fr-FR',{minimumFractionDigits:2}) + (d.cur=='EUR'?' ‚Ç¨':' $'); }

        // --- NAVIGATION ---
        window.go = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'stats') drawStats();
        }

        window.openModal = (id) => document.getElementById('modal-'+id).classList.add('open');
        window.closeModal = (e, id) => { if(!e || e.target.id === 'modal-'+id) document.getElementById('modal-'+id).classList.remove('open'); };

        // --- CORE FUNCTIONS ---
        window.addAcc = () => {
            d.acc.push({ type:val('acc-type'), name:val('acc-name'), bal:val('acc-bal') });
            save(); closeModal(null,'acc');
        };

        window.addTx = () => {
            let v = parseFloat(val('tx-amt'));
            let t = val('tx-type');
            d.tx.push({ type:t, amt:v, cat:val('tx-cat'), date:new Date() });
            if(d.acc.length) d.acc[0].bal = parseFloat(d.acc[0].bal) + (t=='income'?v:-v);
            save(); closeModal(null,'tx');
        };

        window.addBudget = () => {
            d.bud.push({ cat:val('bud-cat'), lim:val('bud-lim') });
            save(); closeModal(null,'bud');
        };

        window.addGoal = () => {
            d.goal.push({ name:val('goal-name'), target:val('goal-target'), cur:val('goal-cur') });
            save(); closeModal(null,'goal');
        };

        function val(id) { return document.getElementById(id).value; }

        // --- RENDER ---
        function render() {
            // Header
            let tot = d.acc.reduce((s,a)=>s+parseFloat(a.bal),0);
            document.getElementById('totalBalance').innerText = fmt(tot);
            document.getElementById('accCount').innerText = d.acc.length + " comptes";

            // Accounts
            let h = '';
            d.acc.forEach(a => {
                let ico = a.type=='crypto'?'‚Çø':(a.type=='stock'?'üìà':'üè¶');
                h += `<div class="card row"><div style="display:flex;align-items:center"><div class="icon">${ico}</div><div class="info"><b>${a.name}</b><span>${a.type}</span></div></div><b>${fmt(a.bal)}</b></div>`;
            });
            document.getElementById('list-acc').innerHTML = h || '<div class="card" style="text-align:center;opacity:0.5">Aucun compte</div>';

            // Transactions
            let txH = '';
            d.tx.slice().reverse().slice(0,5).forEach(t => {
                txH += `<div class="row"><div style="display:flex;align-items:center"><div class="icon">${t.type=='income'?'‚¨áÔ∏è':'‚¨ÜÔ∏è'}</div><div class="info"><b>${t.cat}</b><span>${new Date(t.date).toLocaleDateString()}</span></div></div><b style="color:${t.type=='income'?'#10b981':'#0f172a'}">${t.type=='income'?'+':'-'}${fmt(t.amt)}</b></div>`;
            });
            if(txH) document.getElementById('list-tx').innerHTML = txH;

            // Budgets & Goals
            let bH = '';
            d.bud.forEach(b => {
                let spent = d.tx.filter(t=>t.type=='expense' && t.cat==b.cat).reduce((s,t)=>s+t.amt,0);
                let pct = Math.min((spent/b.lim)*100, 100);
                bH += `<div class="card"><div style="display:flex;justify-content:space-between"><b>${b.cat}</b><small>${fmt(spent)} / ${fmt(b.lim)}</small></div><div style="height:6px;background:#f1f5f9;margin-top:5px;border-radius:3px"><div style="height:100%;width:${pct}%;background:${pct>90?'red':'#4f46e5'};border-radius:3px"></div></div></div>`;
            });
            document.getElementById('list-budget').innerHTML = bH || '<div class="card" style="opacity:0.5;text-align:center">Aucun budget</div>';

            let gH = '';
            d.goal.forEach(g => {
                let pct = Math.min((g.cur/g.target)*100, 100);
                gH += `<div class="card"><div style="display:flex;justify-content:space-between"><b>${g.name}</b><small>${Math.round(pct)}%</small></div><div style="height:6px;background:#f1f5f9;margin-top:5px;border-radius:3px"><div style="height:100%;width:${pct}%;background:#10b981;border-radius:3px"></div></div></div>`;
            });
            document.getElementById('list-goal').innerHTML = gH || '<div class="card" style="opacity:0.5;text-align:center">Aucun objectif</div>';
        }

        // --- MARKET ---
        async function getMarket(filter='all') {
            document.getElementById('list-market').innerHTML = 'Chargement...';
            try {
                if(market.length === 0) {
                    let res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=eur&ids=bitcoin,ethereum,solana,binancecoin,ripple&sparkline=false');
                    let json = await res.json();
                    let stocks = [{id:'aapl',symbol:'aapl',name:'Apple',current_price:185,price_change_percentage_24h:1.2,image:'https://cdn-icons-png.flaticon.com/512/0/747.png',type:'stock'},{id:'tsla',symbol:'tsla',name:'Tesla',current_price:215,price_change_percentage_24h:-2.4,image:'https://cdn-icons-png.flaticon.com/512/5969/5969049.png',type:'stock'}];
                    market = [...json.map(c=>({...c,type:'crypto'})), ...stocks];
                }
                
                let data = filter=='all' ? market : market.filter(i=>i.type==filter);
                let h = '';
                data.forEach(i => {
                    let isUp = i.price_change_percentage_24h >= 0;
                    h += `<div class="card row"><div style="display:flex;align-items:center"><img src="${i.image}" style="width:30px;border-radius:50%;margin-right:10px"><div class="info"><b>${i.symbol.toUpperCase()}</b><span>${i.name}</span></div></div><div style="text-align:right"><b>${fmt(i.current_price)}</b><br><span style="color:${isUp?'#10b981':'red'};font-size:12px">${isUp?'+':''}${i.price_change_percentage_24h.toFixed(2)}%</span></div></div>`;
                });
                document.getElementById('list-market').innerHTML = h;
            } catch(e) { document.getElementById('list-market').innerHTML = "Erreur chargement"; }
        }
        window.loadMarket = getMarket;

        // --- STATS ---
        function drawStats() {
            let cats = {}; let tot = 0;
            d.tx.filter(t=>t.type=='expense').forEach(t=>{ cats[t.cat] = (cats[t.cat]||0)+t.amt; tot+=t.amt; });
            
            let h = ''; let leg = '';
            if(tot > 0) {
                let colors = ['#4f46e5', '#ef4444', '#10b981', '#f59e0b', '#06b6d4'];
                let i = 0;
                for(let c in cats) {
                    let pct = (cats[c]/tot)*100;
                    let col = colors[i%colors.length];
                    h += `<div style="height:${Math.max(pct, 10)}%; background:${col}; flex:1; margin:0 2px; border-radius:4px 4px 0 0" title="${c}"></div>`;
                    leg += `<span style="margin-right:10px; font-size:12px"><span style="color:${col}">‚óè</span> ${c} ${Math.round(pct)}%</span>`;
                    i++;
                }
            } else { h = '<div style="width:100%;text-align:center;margin-top:40px;opacity:0.5">Pas de donn√©es</div>'; }
            
            document.getElementById('stats-bars').innerHTML = h;
            document.getElementById('stats-legend').innerHTML = leg;
        }

        // --- SETTINGS ---
        window.setCurrency = (v) => { d.cur = v; save(); };
        window.pay = () => { 
            if(confirm("Payer 5‚Ç¨ ?")) { d.pro = true; save(); checkPro(); closeModal(null,'pay'); alert("Bienvenue PRO !"); }
        };
        window.resetAll = () => { if(confirm("S√ªr ?")) { localStorage.clear(); location.reload(); } };

        function checkPro() {
            if(d.pro) {
                document.querySelectorAll('.ad').forEach(e=>e.style.display='none');
                document.getElementById('pro').style.display='inline-block';
                document.getElementById('premium-offer').innerHTML = '<h3 style="color:green">Compte PRO Actif ‚úÖ</h3>';
            } else {
                document.querySelectorAll('.ad').forEach(e=>e.style.display='block');
                document.getElementById('pro').style.display='none';
            }
        }

    </script>
</body>
</html>
