<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Finance Master</title>

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpbmFuY2UgTWFzdGVyIiwKICAic2hvcnRfbmFtZSI6ICJGaW5hbmNlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAiaWNvbnMiOiBbXQp9">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* DESIGN SYSTEM (OLED BLACK) */
            --bg: #000000;
            --surface: #0a0a0a;
            --surface-light: #161616;
            --primary: #007AFF; 
            --text-main: #ffffff;
            --text-muted: #888888;
            --success: #32D74B;
            --danger: #FF453A;
            --gold: #FFD60A;
            --border: 1px solid rgba(255,255,255,0.08);
            --radius: 20px;
            --safe-bottom: env(safe-area-inset-bottom);
            --font: 'Inter', sans-serif;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family: var(--font); user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text-main);
            padding-bottom: calc(100px + var(--safe-bottom));
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .header {
            padding: 20px 24px 0;
            background: rgba(0,0,0,0.8);
            position: sticky; top: 0; z-index: 50;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand { font-size: 16px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .pro-badge { background: var(--gold); color: black; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 900; }
        
        .balance-card { text-align: center; padding: 30px 0; }
        .label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; }
        .amount-big { font-size: 46px; font-weight: 800; letter-spacing: -1.5px; margin: 10px 0; background: linear-gradient(180deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* --- LAYOUT --- */
        .container { padding: 0 20px; animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .view { display: none; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 40px 0 15px; }
        .title { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }

        /* --- COMPONENTS --- */
        .card { background: var(--surface); border: var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; position: relative; overflow: hidden; }
        
        .row { display: flex; align-items: center; padding: 8px 0; }
        .icon { 
            width: 48px; height: 48px; border-radius: 16px; background: var(--surface-light); 
            display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 16px; 
            color: var(--text-main); border: var(--border);
        }
        .col-info { flex: 1; }
        .name { font-size: 16px; font-weight: 600; display: block; margin-bottom: 2px; }
        .sub { font-size: 13px; color: var(--text-muted); font-weight: 500; }
        .col-amount { text-align: right; }
        .val { font-size: 16px; font-weight: 700; }
        .green { color: var(--success); } .red { color: var(--danger); }

        /* --- BUTTONS --- */
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; background: var(--surface-light); border: var(--border); display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        
        .btn-primary { 
            width: 100%; padding: 18px; background: var(--primary); color: white; 
            border: none; border-radius: 18px; font-size: 16px; font-weight: 600; 
            margin-top: 20px; cursor: pointer; box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            transition: transform 0.2s;
        }
        .btn-primary:active { transform: scale(0.97); }

        .btn-action-row { display: flex; gap: 12px; margin-bottom: 30px; }
        .btn-action { 
            flex: 1; padding: 16px; background: var(--surface); border: var(--border); 
            border-radius: 16px; color: var(--text-main); font-weight: 600; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
        }
        .btn-action:active { background: var(--surface-light); }

        /* --- NAVIGATION --- */
        .nav { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: rgba(22, 22, 22, 0.9); backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.15); border-radius: 32px; 
            padding: 10px 20px; display: flex; gap: 20px; z-index: 100;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .nav-item { padding: 10px; color: var(--text-muted); font-size: 22px; transition: 0.3s; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item.active::after { content:''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }

        /* --- MARKET --- */
        .chip-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
        .chip { padding: 8px 16px; background: var(--surface); border: var(--border); border-radius: 100px; font-size: 13px; font-weight: 600; color: var(--text-muted); white-space: nowrap; transition: 0.2s; }
        .chip.active { background: var(--text-main); color: black; border-color: var(--text-main); }

        /* --- MODALS (Bottom Sheet) --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: flex-end; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .overlay.open { display: flex; opacity: 1; }
        .sheet { background: #121212; width: 100%; border-radius: 32px 32px 0 0; padding: 30px 24px 50px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1); border-top: 1px solid rgba(255,255,255,0.1); }
        .overlay.open .sheet { transform: translateY(0); }
        
        /* --- ONBOARDING --- */
        #onboarding { z-index: 300; background: #000; }
        #onboarding .sheet { height: 100vh; border-radius: 0; padding-top: 100px; display: flex; flex-direction: column; justify-content: center; background: radial-gradient(circle at top right, #1e1b4b 0%, #000 60%); }

        /* --- INPUTS --- */
        .input-wrap { margin-bottom: 20px; }
        .input-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .input-field { width: 100%; padding: 18px; background: #000; border: 1px solid #333; border-radius: 16px; color: white; font-size: 16px; outline: none; transition: 0.2s; font-weight: 500; }
        .input-field:focus { border-color: var(--primary); }

        /* --- TOAST --- */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; color: black; padding: 12px 24px; border-radius: 100px; font-weight: 700; font-size: 14px; z-index: 999; transition: 0.4s; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>

    <div id="toast"><i class="fa-solid fa-check-circle" style="color:var(--success)"></i> <span>Message</span></div>

    <div class="header">
        <div class="top-row">
            <div class="brand"><i class="fa-solid fa-cube" style="color:var(--primary)"></i> Finance Master <span id="pro" class="pro-badge" style="display:none">PRO</span></div>
            <div class="btn-icon" onclick="openSheet('settings')"><i class="fa-solid fa-sliders"></i></div>
        </div>
        <div class="balance-card">
            <div class="label">Patrimoine Net</div>
            <div class="amount-big" id="totalWealth">0 €</div>
            <div style="font-size:13px; color:var(--text-muted); display:flex; align-items:center; justify-content:center; gap:6px;">
                <span style="width:8px; height:8px; background:var(--success); border-radius:50%; box-shadow:0 0 10px var(--success)"></span> 
                Marché en direct
            </div>
        </div>
    </div>

    <div class="container">
        
        <div id="view-home" class="view active">
            <div class="btn-action-row">
                <div class="btn-action" onclick="openSheet('acc')"><i class="fa-solid fa-wallet" style="color:var(--primary)"></i> Ajouter</div>
                <div class="btn-action" onclick="document.getElementById('csvImport').click()"><i class="fa-solid fa-file-csv"></i> Import CSV</div>
                <input type="file" id="csvImport" hidden onchange="importCSV(event)">
            </div>

            <div class="section-header"><div class="title">Mes Comptes</div></div>
            <div id="accList"></div>

            <div class="section-header"><div class="title">Activités</div><div class="btn-icon" onclick="openSheet('tx')"><i class="fa-solid fa-plus"></i></div></div>
            <div id="txList"></div>
        </div>

        <div id="view-market" class="view">
            <div class="chip-row">
                <div class="chip active" onclick="filterMarket('all', this)">Tout</div>
                <div class="chip" onclick="filterMarket('crypto', this)">Cryptos</div>
                <div class="chip" onclick="filterMarket('stock', this)">Actions</div>
            </div>
            <input type="text" class="input-field" placeholder="Rechercher (BTC, Apple...)" oninput="filterMarketSearch(this.value)" style="margin-bottom:20px">
            <div id="marketList"></div>
        </div>

        <div id="view-stats" class="view">
            <div class="card">
                <h3 style="margin-bottom:20px">Dépenses par catégorie</h3>
                <canvas id="chart1"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-bottom:20px">Évolution</h3>
                <canvas id="chart2"></canvas>
            </div>
        </div>

        </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchView('home', this)"><i class="fa-solid fa-house"></i></div>
        <div class="nav-item" onclick="switchView('market', this)"><i class="fa-solid fa-chart-line"></i></div>
        <div class="nav-item" onclick="switchView('stats', this)"><i class="fa-solid fa-chart-pie"></i></div>
    </div>

    <div id="onboarding" class="overlay">
        <div class="sheet">
            <div style="text-align:center; margin-bottom:40px;">
                <i class="fa-solid fa-shield-halved" style="font-size:60px; color:var(--primary); margin-bottom:20px;"></i>
                <h1>Bienvenue</h1>
                <p style="color:var(--text-muted); margin-top:10px;">Configuration sécurisée. Vos données restent sur votre appareil.</p>
            </div>
            <div class="input-wrap"><label class="input-label">Banque principale</label><input id="setupName" type="text" class="input-field" placeholder="Ex: Boursorama"></div>
            <div class="input-wrap"><label class="input-label">Solde actuel (€)</label><input id="setupBal" type="number" step="0.01" class="input-field" placeholder="0.00"></div>
            <button class="btn-primary" onclick="finishOnboarding()">Commencer</button>
        </div>
    </div>

    <div id="sheet-acc" class="overlay" onclick="closeSheet(event, 'acc')">
        <div class="sheet">
            <h2 style="margin-bottom:20px">Nouveau Compte</h2>
            <div class="input-wrap">
                <label class="input-label">Type</label>
                <select id="accType" class="input-field">
                    <option value="bank">Compte Bancaire</option>
                    <option value="crypto">Portefeuille Crypto</option>
                    <option value="stock">Bourse / PEA</option>
                    <option value="immo">Immobilier</option>
                </select>
            </div>
            <div class="input-wrap"><label class="input-label">Nom</label><input id="accName" type="text" class="input-field"></div>
            <div class="input-wrap"><label class="input-label">Solde (€)</label><input id="accBal" type="number" class="input-field"></div>
            <button class="btn-primary" onclick="addAccount()">Créer</button>
        </div>
    </div>

    <div id="sheet-tx" class="overlay" onclick="closeSheet(event, 'tx')">
        <div class="sheet">
            <h2 style="margin-bottom:20px">Transaction</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px">
                <button id="btnExp" onclick="setTxType('expense')" style="flex:1; padding:15px; background:var(--surface-light); border:1px solid var(--primary); border-radius:12px; color:white; font-weight:600;">Dépense</button>
                <button id="btnInc" onclick="setTxType('income')" style="flex:1; padding:15px; background:var(--bg); border:none; border-radius:12px; color:var(--text-muted); font-weight:600;">Revenu</button>
            </div>
            <div class="input-wrap"><label class="input-label">Montant</label><input id="txAmount" type="number" class="input-field" style="font-size:24px; font-weight:700;"></div>
            <div class="input-wrap"><label class="input-label">Catégorie</label><input id="txCat" type="text" class="input-field" list="cats"><datalist id="cats"><option value="Courses"><option value="Loyer"><option value="Salaire"></datalist></div>
            <button class="btn-primary" onclick="addTransaction()">Valider</button>
        </div>
    </div>

    <div id="sheet-settings" class="overlay" onclick="closeSheet(event, 'settings')">
        <div class="sheet">
            <h2 style="margin-bottom:20px">Réglages</h2>
            <div class="card" onclick="exportData()" style="display:flex; align-items:center; cursor:pointer">
                <div class="icon"><i class="fa-solid fa-download"></i></div>
                <div class="col-info"><span class="name">Sauvegarder</span><span class="sub">Export JSON</span></div>
            </div>
            <div class="card" style="border-color:var(--danger); text-align:center" onclick="hardReset()">
                <span class="name" style="color:var(--danger)">Réinitialiser l'application</span>
            </div>
            <div style="text-align:center; font-size:11px; opacity:0.5; margin-top:20px">v17.0 Ultimate</div>
        </div>
    </div>

    <script>
        // CONFIG & STATE
        const APP_VERSION = '17.0';
        let db = { accounts: [], transactions: [], user: { pro: false } };
        let marketData = [];
        let txType = 'expense';
        let charts = {};

        // MOCK DATA FOR REALISTIC FALLBACK (Binance Prices Approx)
        const MOCK_MARKET = [
            { id: 'bitcoin', symbol: 'BTC', name: 'Bitcoin', price: 43100, change: 1.2 },
            { id: 'ethereum', symbol: 'ETH', name: 'Ethereum', price: 2350, change: -0.5 },
            { id: 'solana', symbol: 'SOL', name: 'Solana', price: 95.20, change: 4.8 },
            { id: 'binancecoin', symbol: 'BNB', name: 'BNB', price: 310, change: 0.2 },
            { id: 'ripple', symbol: 'XRP', name: 'XRP', price: 0.52, change: -1.1 },
            { id: 'apple', symbol: 'AAPL', name: 'Apple Inc.', price: 185.50, change: 0.8 },
            { id: 'tesla', symbol: 'TSLA', name: 'Tesla', price: 215.00, change: -2.4 },
            { id: 'nvidia', symbol: 'NVDA', name: 'NVIDIA', price: 600.00, change: 3.5 }
        ];

        // INIT
        window.onload = () => {
            // Force clean old versions
            if(localStorage.getItem('app_ver') !== APP_VERSION) {
                localStorage.clear();
                localStorage.setItem('app_ver', APP_VERSION);
            }
            
            // Load Data
            if(localStorage.getItem('db')) db = JSON.parse(localStorage.getItem('db'));

            // Check Onboarding
            if(db.accounts.length === 0) {
                document.getElementById('onboarding').classList.add('open');
                document.getElementById('onboarding').style.display = 'flex';
            } else {
                initApp();
            }
        };

        function finishOnboarding() {
            const name = document.getElementById('setupName').value;
            const bal = parseFloat(document.getElementById('setupBal').value);
            if(name && !isNaN(bal)) {
                db.accounts.push({ id:Date.now(), name, type:'bank', balance:bal });
                save();
                // Force close
                document.getElementById('onboarding').classList.remove('open');
                setTimeout(() => document.getElementById('onboarding').style.display='none', 300);
                initApp();
            } else { alert("Champs requis"); }
        }

        function initApp() {
            updateUI();
            fetchMarket(); // Lance la récup des prix
        }

        function save() { localStorage.setItem('db', JSON.stringify(db)); updateUI(); }
        function fmt(n) { return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' }).format(n); }
        function toast(t) { 
            const el = document.getElementById('toast'); 
            el.innerHTML = `<i class="fa-solid fa-check-circle" style="color:var(--success)"></i> ${t}`;
            el.style.transform = "translateX(-50%) translateY(0)";
            setTimeout(() => el.style.transform = "translateX(-50%) translateY(-100px)", 3000);
        }

        // CORE UI
        function updateUI() {
            // Header
            let total = db.accounts.reduce((s,a) => s + a.balance, 0);
            document.getElementById('totalWealth').innerText = fmt(total);

            // Accounts
            const accEl = document.getElementById('accList');
            if(db.accounts.length === 0) {
                accEl.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">Aucun compte</div>';
            } else {
                accEl.innerHTML = db.accounts.map(a => `
                    <div class="card row">
                        <div class="icon" style="color:${getColor(a.type)}"><i class="fa-solid ${getIcon(a.type)}"></i></div>
                        <div class="col-info"><span class="name">${a.name}</span><span class="sub">${getTypeName(a.type)}</span></div>
                        <div class="col-amount"><span class="val">${fmt(a.balance)}</span></div>
                    </div>
                `).join('');
            }

            // Transactions
            const txEl = document.getElementById('txList');
            if(db.transactions.length === 0) {
                txEl.innerHTML = '<div class="card" style="text-align:center; opacity:0.5; padding:30px;">Aucune activité</div>';
            } else {
                txEl.innerHTML = db.transactions.slice().reverse().slice(0,5).map(t => `
                    <div class="row" style="border-bottom:1px solid rgba(255,255,255,0.05); padding:10px 0;">
                        <div class="icon" style="width:36px; height:36px; font-size:14px; margin-right:12px;">
                            <i class="fa-solid ${t.type=='income'?'fa-arrow-down':'fa-arrow-up'}" style="color:${t.type=='income'?'var(--success)':'var(--text-main)'}"></i>
                        </div>
                        <div class="col-info"><span class="name" style="font-size:14px;">${t.category}</span><span class="sub">${new Date(t.date).toLocaleDateString()}</span></div>
                        <div class="col-amount"><span class="val ${t.type=='income'?'green':'red'}">${t.type=='income'?'+':'-'}${fmt(t.amount)}</span></div>
                    </div>
                `).join('');
            }

            renderCharts();
        }

        // MARKET ENGINE (Binance/CoinGecko Hybrid + Fallback)
        async function fetchMarket() {
            const el = document.getElementById('marketList');
            el.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">Mise à jour des cours...</div>';
            
            // 1. Afficher Mock immédiatement pour éviter le vide
            marketData = MOCK_MARKET;
            renderMarket(marketData);

            try {
                // 2. Tenter API Binance (Prix temps réel, pas de limite stricte)
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbols=["BTCEUR","ETHEUR","SOLEUR","BNBEUR","XRPEUR"]');
                if(res.ok) {
                    const data = await res.json();
                    // Mise à jour des prix crypto uniquement
                    data.forEach(item => {
                        const symbol = item.symbol.replace('EUR','');
                        const idx = marketData.findIndex(m => m.symbol === symbol);
                        if(idx !== -1) marketData[idx].price = parseFloat(item.price);
                    });
                    renderMarket(marketData);
                }
            } catch(e) {
                console.log("Mode hors ligne ou API bloquée, utilisation cache.");
            }
        }

        function renderMarket(data) {
            document.getElementById('marketList').innerHTML = data.map(i => `
                <div class="card row">
                    <div class="icon" style="width:40px; height:40px; border-radius:50%; font-size:14px; font-weight:700;">${i.symbol[0]}</div>
                    <div class="col-info"><span class="name">${i.symbol}</span><span class="sub">${i.name}</span></div>
                    <div class="col-amount">
                        <span class="val">${fmt(i.price)}</span>
                        <span class="sub ${i.change>=0?'green':'red'}">${i.change>0?'+':''}${i.change}%</span>
                    </div>
                </div>
            `).join('');
        }

        function filterMarketSearch(val) {
            const q = val.toLowerCase();
            renderMarket(marketData.filter(i => i.name.toLowerCase().includes(q) || i.symbol.toLowerCase().includes(q)));
        }
        function filterMarket(type, el) {
            document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
            if(type=='all') renderMarket(marketData);
            if(type=='crypto') renderMarket(marketData.slice(0,5));
            if(type=='stock') renderMarket(marketData.slice(5));
        }

        // ACTIONS
        function setTxType(t) {
            txType = t;
            const btnExp = document.getElementById('btnExp');
            const btnInc = document.getElementById('btnInc');
            if(t=='expense') {
                btnExp.style.background = 'var(--surface-light)'; btnExp.style.border = '1px solid var(--primary)'; btnExp.style.color='white';
                btnInc.style.background = 'var(--bg)'; btnInc.style.border = 'none'; btnInc.style.color='var(--text-muted)';
            } else {
                btnInc.style.background = 'var(--surface-light)'; btnInc.style.border = '1px solid var(--success)'; btnInc.style.color='white';
                btnExp.style.background = 'var(--bg)'; btnExp.style.border = 'none'; btnExp.style.color='var(--text-muted)';
            }
        }

        function addAccount() {
            db.accounts.push({ id:Date.now(), name:val('accName'), type:val('accType'), balance:parseFloat(val('accBal')) });
            save(); closeSheet(null,'acc'); toast('Compte ajouté');
        }

        function addTransaction() {
            let v = parseFloat(val('txAmount'));
            if(isNaN(v)) return;
            db.transactions.push({ id:Date.now(), amount:v, type:txType, category:val('txCat'), date:new Date() });
            
            // Mise à jour du solde du premier compte trouvé
            if(db.accounts.length > 0) {
                db.accounts[0].balance += (txType=='income' ? v : -v);
            }
            save(); closeSheet(null,'tx'); toast('Transaction validée');
        }

        function importCSV(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const lines = event.target.result.split('\n');
                let count = 0; let sum = 0;
                lines.forEach(line => {
                    const cols = line.split(/[;,]/); // Détecte ; ou ,
                    if(cols.length >= 2) {
                        // Cherche le montant (souvent dernière colonne ou avant-dernière)
                        let rawAmt = cols[cols.length-1].replace(/\s/g,'').replace(',','.');
                        let amt = parseFloat(rawAmt);
                        if(!isNaN(amt)) {
                            db.transactions.push({ id:Date.now()+Math.random(), amount:Math.abs(amt), type: amt>0?'income':'expense', category:'Import', date:new Date() });
                            sum += amt; count++;
                        }
                    }
                });
                if(db.accounts.length > 0) db.accounts[0].balance += sum;
                save(); toast(`${count} opérations importées`);
            };
            reader.readAsText(file);
        }

        // CHARTS
        function renderCharts() {
            const ctx1 = document.getElementById('chart1');
            const cats = {}; db.transactions.filter(t=>t.type=='expense').forEach(t => cats[t.category] = (cats[t.category]||0)+t.amount);
            
            if(charts.cat) charts.cat.destroy();
            charts.cat = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor:['#3B82F6','#F59E0B','#EF4444','#10B981'], borderWidth:0 }]
                },
                options: { plugins: { legend: {position:'right', labels:{color:'#888', boxWidth:10}} }, cutout:'75%' }
            });

            const ctx2 = document.getElementById('chart2');
            if(charts.line) charts.line.destroy();
            charts.line = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['J','F','M','A','M','J'],
                    datasets: [{ label:'Solde', data:[1000, 1200, 1100, 1400, 1350, 1600], borderColor:'#3B82F6', tension:0.4 }]
                },
                options: { scales: { x:{display:false}, y:{display:false} }, plugins:{legend:{display:false}} }
            });
        }

        // HELPERS
        function val(id) { return document.getElementById(id).value; }
        function getIcon(t) { return {bank:'fa-landmark', crypto:'fa-bitcoin', stock:'fa-chart-line', immo:'fa-house'}[t] || 'fa-wallet'; }
        function getColor(t) { return {bank:'#3B82F6', crypto:'#F59E0B', stock:'#10B981', immo:'#8B5CF6'}[t] || '#fff'; }
        function getTypeName(t) { return {bank:'Banque', crypto:'Crypto', stock:'Bourse', immo:'Immobilier'}[t]; }

        function switchView(v, el) { 
            document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(el) el.classList.add('active');
            if(v==='stats') renderCharts();
        }
        function openSheet(m) { document.getElementById('sheet-'+m).classList.add('open'); }
        function closeSheet(e,m) { if(!e || e.target.id=='sheet-'+m) document.getElementById('sheet-'+m).classList.remove('open'); }
        function exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const n = document.createElement('a'); n.setAttribute("href", s); n.setAttribute("download", "backup.json"); document.body.appendChild(n); n.click(); n.remove(); }
        function hardReset() { if(confirm('Tout supprimer ?')){ localStorage.clear(); location.reload(); } }

    </script>
</body>
</html>
