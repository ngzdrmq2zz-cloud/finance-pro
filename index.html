<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Finance Master Pro</title>

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpbmFuY2UgTWFzdGVyIFBybyIsCiAgInNob3J0X25hbWUiOiAiRmluYW5jZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzJhIiwKICAidGhlbWVfY29sb3IiOiAiIzBmMTcyYSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjkxMC8yOTEwNzk1LnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwcz6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjkxMC8yOTEwNzk1LnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"> <style>
        :root {
            /* Palette Premium */
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --surface-alt: #f1f5f9;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gold: #fbbf24;
            
            --radius: 20px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #0f172a;
                --surface: #1e293b;
                --surface-alt: #334155;
                --text-main: #f8fafc;
                --text-muted: #94a3b8;
                --primary: #818cf8;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: calc(100px + var(--safe-bottom));
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 20px 20px 100px;
            color: white;
            border-radius: 0 0 35px 35px;
            position: relative;
            box-shadow: 0 10px 40px -10px var(--primary);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        
        .balance-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            position: relative; z-index: 10;
        }
        .balance-label { font-size: 12px; font-weight: 600; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .balance-amount { font-size: 36px; font-weight: 800; margin: 5px 0; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* --- LAYOUT --- */
        .container { padding: 0 20px; margin-top: -60px; position: relative; z-index: 20; }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
        .section-title { font-size: 17px; font-weight: 700; color: var(--text-main); }
        .card { background: var(--surface); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); margin-bottom: 12px; }

        /* --- LISTES --- */
        .list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--surface-alt); }
        .list-item:last-child { border-bottom: none; }
        .icon-box { width: 42px; height: 42px; border-radius: 12px; background: var(--surface-alt); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 15px; }
        .item-info { flex: 1; }
        .item-title { font-weight: 600; font-size: 15px; }
        .item-sub { font-size: 12px; color: var(--text-muted); }
        .amount { font-weight: 700; font-size: 15px; }
        .inc { color: var(--success); } .exp { color: var(--text-main); }

        /* --- ELEMENTS UI --- */
        .btn-add { width: 30px; height: 30px; background: var(--text-main); color: var(--bg-body); border-radius: 8px; border: none; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-full { width: 100%; padding: 16px; background: var(--primary); color: white; font-weight: 700; border-radius: 14px; border: none; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(99,102,241,0.3); }
        .input { width: 100%; padding: 14px; border-radius: 12px; background: var(--surface-alt); border: none; font-size: 16px; color: var(--text-main); margin-bottom: 15px; outline: none; }
        .input:focus { background: var(--surface); box-shadow: 0 0 0 2px var(--primary); }
        .label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display: block; }
        
        .progress-track { height: 8px; background: var(--surface-alt); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease; }
        
        /* --- NAVIGATION --- */
        .nav-dock {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border-radius: 24px; padding: 10px 15px;
            display: flex; justify-content: space-between;
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15); z-index: 100;
            border: 1px solid rgba(128,128,128,0.1);
        }
        @media (prefers-color-scheme: dark) { .nav-dock { background: rgba(30,41,59,0.9); } }
        .nav-item { font-size: 20px; color: var(--text-muted); padding: 10px; border-radius: 12px; transition: 0.2s; cursor: pointer; }
        .nav-item.active { color: var(--primary); background: var(--surface-alt); transform: translateY(-5px); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; }
        .modal-sheet { background: var(--surface); width: 100%; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.16,1,0.3,1); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        .handle { width: 40px; height: 5px; background: var(--surface-alt); border-radius: 10px; margin: 0 auto 20px; }

        /* --- EXTRAS --- */
        .ad-box { background: var(--surface); border: 1px dashed var(--text-muted); border-radius: 16px; padding: 15px; text-align: center; margin-bottom: 20px; display: none; }
        .skeleton { background: linear-gradient(90deg, var(--surface-alt) 25%, var(--bg-body) 50%, var(--surface-alt) 75%); background-size: 200% 100%; animation: load 1.5s infinite; border-radius: 6px; }
        @keyframes load { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    </style>
</head>
<body>

    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px); background:#0f172a; color:white; padding:12px 24px; border-radius:30px; font-weight:600; z-index:300; transition:0.3s; display:flex; gap:8px; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.2);"></div>

    <div class="header">
        <div class="top-bar">
            <div class="logo"><i class="fa-solid fa-wallet"></i> Finance <span id="proBadge" style="display:none; background:#fbbf24; color:black; font-size:10px; padding:2px 6px; border-radius:6px; margin-left:5px;">PRO</span></div>
            <div style="width:36px; height:36px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="switchView('settings')"><i class="fa-solid fa-gear"></i></div>
        </div>
        <div class="balance-card">
            <div style="font-size:12px; font-weight:600; opacity:0.8; text-transform:uppercase;">Patrimoine Total</div>
            <div class="balance-amount" id="totalBalance">---</div>
            <div style="font-size:13px; opacity:0.8" id="balanceDetails"><span class="skeleton" style="width:100px; height:10px; display:inline-block"></span></div>
        </div>
    </div>

    <div class="nav-dock">
        <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fa-solid fa-house"></i></div>
        <div class="nav-item" onclick="switchView('budget', this)"><i class="fa-solid fa-chart-simple"></i></div>
        <div class="nav-item" onclick="switchView('market', this)"><i class="fa-solid fa-arrow-trend-up"></i></div>
        <div class="nav-item" onclick="switchView('recurring', this)"><i class="fa-solid fa-rotate"></i></div>
        <div class="nav-item" onclick="switchView('stats', this)"><i class="fa-solid fa-chart-pie"></i></div>
    </div>

    <div class="container">
        
        <div id="dashboardView" class="view active">
            <div class="ad-box" id="ad1"><small>PUBLICIT√â</small><br>Espace Google Ads</div>
            
            <div class="section-header"><span class="section-title">Comptes</span><button class="btn-add" onclick="openModal('modalAccount')">+</button></div>
            <div id="accountsList"></div>

            <div class="section-header"><span class="section-title">Transactions</span><button class="btn-add" onclick="openModal('modalTransac')">+</button></div>
            <div id="transactionsList" class="card" style="min-height:100px;"></div>
        </div>

        <div id="budgetView" class="view">
            <div class="section-header"><span class="section-title">Budgets Mensuels</span><button class="btn-add" onclick="openModal('modalBudget')">+</button></div>
            <div id="budgetList"></div>

            <div class="section-header"><span class="section-title">Objectifs d'√âpargne</span><button class="btn-add" onclick="openModal('modalGoal')">+</button></div>
            <div id="goalsList"></div>
        </div>

        <div id="marketView" class="view">
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:10px;">
                <button class="btn-add" style="width:auto; padding:0 15px; background:var(--text-main);" onclick="filterMarket('all')">Tout</button>
                <button class="btn-add" style="width:auto; padding:0 15px; background:var(--surface); color:var(--text-muted); border:1px solid var(--surface-alt);" onclick="filterMarket('crypto')">Crypto</button>
                <button class="btn-add" style="width:auto; padding:0 15px; background:var(--surface); color:var(--text-muted); border:1px solid var(--surface-alt);" onclick="filterMarket('stock')">Bourse</button>
            </div>
            <input type="text" class="input" placeholder="Rechercher..." oninput="searchMarket(this.value)">
            <div class="ad-box" id="ad2">üì¢ Trading sans frais (Pub)</div>
            <div id="marketList" class="card" style="min-height:200px;"></div>
        </div>

        <div id="recurringView" class="view">
            <div class="section-header"><span class="section-title">Abonnements & Fixes</span><button class="btn-add" onclick="openModal('modalRecurring')">+</button></div>
            <div class="card" style="background:linear-gradient(135deg, #6366f1, #4338ca); color:white;">
                <div style="font-size:12px; opacity:0.8;">Total Mensuel Fixe</div>
                <div style="font-size:24px; font-weight:700;" id="totalRecurring">0 ‚Ç¨</div>
            </div>
            <div id="recurringList"></div>
        </div>

        <div id="statsView" class="view">
            <div class="section-header"><span class="section-title">Analyse</span></div>
            <div class="card"><canvas id="catChart"></canvas></div>
            <div class="section-header"><span class="section-title">Cashflow (6 mois)</span></div>
            <div class="card"><canvas id="flowChart"></canvas></div>
        </div>

        <div id="settingsView" class="view">
            <div class="section-header"><span class="section-title">Options</span></div>
            
            <div class="card">
                <div class="list-item">
                    <div class="icon-box"><i class="fa-solid fa-coins"></i></div>
                    <div class="item-info"><div class="item-title">Devise</div></div>
                    <select id="currencySelect" style="border:none; font-weight:bold; background:transparent;" onchange="changeCurrency(this.value)">
                        <option value="EUR">EUR (‚Ç¨)</option><option value="USD">USD ($)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="list-item" onclick="exportData()">
                    <div class="icon-box"><i class="fa-solid fa-download"></i></div>
                    <div class="item-info"><div class="item-title">Sauvegarder (JSON)</div></div>
                </div>
                <div class="list-item" onclick="document.getElementById('importFile').click()">
                    <div class="icon-box"><i class="fa-solid fa-upload"></i></div>
                    <div class="item-info"><div class="item-title">Restaurer (JSON)</div></div>
                    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
                </div>
            </div>

            <div class="card" id="premiumBox" style="background:#fffbeb; border:1px solid #fbbf24; text-align:center;">
                <div style="font-size:40px; margin-bottom:10px;">üíé</div>
                <h3 style="color:#b45309; margin-bottom:5px;">Version PRO</h3>
                <p style="font-size:13px; color:#b45309; margin-bottom:15px;">Supprimez les pubs √† vie.</p>
                <button class="btn-full" style="background:#d97706" onclick="openModal('modalPay')">D√©bloquer (5,00‚Ç¨)</button>
            </div>

            <div style="text-align:center; margin-top:30px;">
                <button onclick="resetApp()" style="color:var(--danger); background:none; border:none; font-weight:bold;">R√©initialiser Tout</button>
            </div>
        </div>

    </div>

    <div id="modalAccount" class="modal-overlay" onclick="closeModal(event, 'modalAccount')">
        <div class="modal-sheet">
            <div class="handle"></div><h3>Nouveau Compte</h3>
            <label class="label">Type</label><select id="accType" class="input"><option value="bank">Banque</option><option value="crypto">Crypto</option><option value="stock">Bourse</option></select>
            <label class="label">Nom</label><input id="accName" type="text" class="input">
            <label class="label">Solde</label><input id="accBal" type="number" step="0.01" class="input">
            <button class="btn-full" onclick="addAccount()">Ajouter</button>
        </div>
    </div>

    <div id="modalTransac" class="modal-overlay" onclick="closeModal(event, 'modalTransac')">
        <div class="modal-sheet">
            <div class="handle"></div><h3>Transaction</h3>
            <select id="tType" class="input"><option value="expense">D√©pense</option><option value="income">Revenu</option></select>
            <label class="label">Montant</label><input id="tAmount" type="number" step="0.01" class="input" style="font-size:24px; font-weight:800;">
            <label class="label">Cat√©gorie</label><input id="tCat" type="text" class="input" list="cats"><datalist id="cats"><option value="Alimentation"><option value="Logement"></datalist>
            <button class="btn-full" onclick="addTransaction()">Valider</button>
        </div>
    </div>

    <div id="modalBudget" class="modal-overlay" onclick="closeModal(event, 'modalBudget')">
        <div class="modal-sheet">
            <div class="handle"></div><h3>Budget</h3>
            <label class="label">Cat√©gorie</label><input id="bCat" type="text" class="input" list="cats">
            <label class="label">Limite (‚Ç¨)</label><input id="bLimit" type="number" class="input">
            <button class="btn-full" onclick="addBudget()">Cr√©er</button>
        </div>
    </div>

    <div id="modalGoal" class="modal-overlay" onclick="closeModal(event, 'modalGoal')">
        <div class="modal-sheet">
            <div class="handle"></div><h3>Objectif</h3>
            <label class="label">Nom</label><input id="gName" type="text" class="input">
            <label class="label">Cible (‚Ç¨)</label><input id="gTarget" type="number" class="input">
            <label class="label">D√©j√† √©pargn√©</label><input id="gCurrent" type="number" class="input">
            <button class="btn-full" onclick="addGoal()">Fixer</button>
        </div>
    </div>

    <div id="modalRecurring" class="modal-overlay" onclick="closeModal(event, 'modalRecurring')">
        <div class="modal-sheet">
            <div class="handle"></div><h3>R√©current</h3>
            <label class="label">Nom</label><input id="rName" type="text" class="input" placeholder="Netflix...">
            <label class="label">Montant</label><input id="rAmount" type="number" class="input">
            <label class="label">Type</label><select id="rType" class="input"><option value="expense">D√©pense</option><option value="income">Revenu</option></select>
            <button class="btn-full" onclick="addRecurring()">Activer</button>
        </div>
    </div>

    <div id="modalPay" class="modal-overlay" onclick="closeModal(event, 'modalPay')">
        <div class="modal-sheet" style="text-align:center;">
            <div class="handle"></div><h3>Paiement S√©curis√©</h3>
            <p style="margin-bottom:20px; opacity:0.6;">Simulation (Sandbox)</p>
            <button class="btn-full" style="background:#000" onclick="processPayment()">Ô£ø Apple Pay</button>
        </div>
    </div>

    <script>
        // --- GESTION DES DONN√âES ---
        const VER = '10.0'; // Force la mise √† jour
        let state = { accounts:[], transactions:[], budgets:[], goals:[], recurring:[], currency:'EUR', isPremium:false };
        let marketData = [];
        let chartInstance = null;

        // --- D√âMARRAGE ---
        window.onload = () => {
            // Migration de version
            if(localStorage.getItem('app_ver') !== VER) { 
                if(!localStorage.getItem('state')) localStorage.clear();
                localStorage.setItem('app_ver', VER);
            }
            // Chargement Sauvegarde
            if(localStorage.getItem('state')) state = JSON.parse(localStorage.getItem('state'));
            
            initUI();
            processRecurring(); // V√©rifier paiements r√©currents
            setTimeout(fetchMarket, 500); // Charger crypto
        };

        function save() { localStorage.setItem('state', JSON.stringify(state)); updateUI(); }
        
        function initUI() {
            document.getElementById('currencySelect').value = state.currency;
            checkPremium();
            updateUI();
        }

        // Helper Formatage Argent
        function fmt(n) { return (parseFloat(n)*(state.currency=='USD'?1.08:1)).toLocaleString('fr-FR',{minimumFractionDigits:2}) + (state.currency=='EUR'?' ‚Ç¨':' $'); }
        
        // Helper Notification
        function toast(msg) { const t=document.getElementById('toast'); t.innerHTML=`<i class="fa-solid fa-check"></i> ${msg}`; t.style.transform="translateX(-50%) translateY(0)"; setTimeout(()=>t.style.transform="translateX(-50%) translateY(-100px)", 3000); }

        // --- AFFICHAGE PRINCIPAL ---
        function updateUI() {
            // Dashboard Balance
            const total = state.accounts.reduce((s,a)=>s+parseFloat(a.balance),0);
            document.getElementById('totalBalance').innerText = fmt(total);
            document.getElementById('balanceDetails').innerText = `${state.accounts.length} comptes actifs`;

            // Liste Comptes
            const accList = document.getElementById('accountsList');
            accList.innerHTML = state.accounts.length ? state.accounts.map(a => `
                <div class="card list-item">
                    <div class="icon-box" style="color:${a.type=='crypto'?'#8b5cf6':'#4f46e5'}"><i class="fa-solid ${getIcon(a.type)}"></i></div>
                    <div class="item-info"><div class="item-title">${a.name}</div><div class="item-sub">${a.type.toUpperCase()}</div></div>
                    <div class="amount">${fmt(a.balance)}</div>
                </div>`).join('') : '<div style="text-align:center;padding:20px;opacity:0.5">Aucun compte</div>';

            // Liste Transactions
            const txList = document.getElementById('transactionsList');
            txList.innerHTML = state.transactions.length ? state.transactions.slice().reverse().slice(0,5).map(t => `
                <div class="list-item">
                    <div class="icon-box" style="background:${t.type=='income'?'#dcfce7':'#fee2e2'}; color:${t.type=='income'?'#16a34a':'#dc2626'}"><i class="fa-solid ${t.type=='income'?'fa-arrow-down':'fa-arrow-up'}"></i></div>
                    <div class="item-info"><div class="item-title">${t.category}</div><div class="item-sub">${new Date(t.date).toLocaleDateString()}</div></div>
                    <div class="amount ${t.type=='income'?'inc':'exp'}">${t.type=='income'?'+':'-'}${fmt(t.amount)}</div>
                </div>`).join('') : '<div style="text-align:center;padding:20px;opacity:0.5">Aucune transaction</div>';

            // Budgets
            const bList = document.getElementById('budgetList');
            bList.innerHTML = state.budgets.map(b => {
                let spent = state.transactions.filter(t=>t.type=='expense' && t.category==b.category).reduce((s,t)=>s+t.amount,0);
                let pct = Math.min((spent/b.limit)*100, 100);
                return `<div class="card"><div style="display:flex;justify-content:space-between"><b>${b.category}</b><small>${fmt(spent)} / ${fmt(b.limit)}</small></div><div class="progress-track"><div class="progress-fill" style="width:${pct}%; background:${pct>90?'red':'var(--primary)'}"></div></div></div>`;
            }).join('');

            // Objectifs
            const gList = document.getElementById('goalsList');
            gList.innerHTML = state.goals.map(g => {
                let pct = Math.min((g.current/g.target)*100, 100);
                return `<div class="card"><div style="display:flex;justify-content:space-between"><b>${g.name}</b><small>${Math.round(pct)}%</small></div><div class="progress-track"><div class="progress-fill" style="width:${pct}%; background:#10b981"></div></div></div>`;
            }).join('');

            // R√©currents
            const rList = document.getElementById('recurringList');
            const rTot = state.recurring.reduce((s,r)=>s+(r.type=='expense'?-parseFloat(r.amount):parseFloat(r.amount)),0);
            document.getElementById('totalRecurring').innerText = (rTot>0?'+':'')+fmt(rTot);
            rList.innerHTML = state.recurring.map(r => `
                <div class="card list-item">
                    <div class="item-info"><b>${r.name}</b></div>
                    <div class="amount ${r.type=='income'?'inc':'exp'}">${r.type=='income'?'+':'-'}${fmt(r.amount)}</div>
                </div>`).join('');

            updateStats();
        }

        function getIcon(t) { return {bank:'fa-building-columns', crypto:'fa-bitcoin', stock:'fa-arrow-trend-up'}[t] || 'fa-wallet'; }

        // --- FONCTIONS ---
        function addAccount() {
            state.accounts.push({ name:id('accName').value, type:id('accType').value, balance:id('accBal').value });
            save(); closeModal(null,'modalAccount'); toast('Compte ajout√©');
        }
        function addTransaction() {
            const amt = parseFloat(id('tAmount').value);
            const type = id('tType').value;
            state.transactions.push({ amount:amt, type:type, category:id('tCat').value, date:new Date() });
            if(state.accounts.length) { state.accounts[0].balance = parseFloat(state.accounts[0].balance) + (type=='income'?amt:-amt); }
            save(); closeModal(null,'modalTransac'); toast('Transaction ajout√©e');
        }
        function addBudget() {
            state.budgets.push({ category:id('bCat').value, limit:id('bLimit').value });
            save(); closeModal(null,'modalBudget'); toast('Budget cr√©√©');
        }
        function addGoal() {
            state.goals.push({ name:id('gName').value, target:id('gTarget').value, current:id('gCurrent').value });
            save(); closeModal(null,'modalGoal'); toast('Objectif fix√©');
        }
        function addRecurring() {
            state.recurring.push({ name:id('rName').value, amount:id('rAmount').value, type:id('rType').value });
            save(); closeModal(null,'modalRecurring'); toast('Abonnement ajout√©');
        }

        // --- MARCH√â ---
        async function fetchMarket() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=eur&ids=bitcoin,ethereum,solana,binancecoin,ripple&sparkline=false');
                marketData = await res.json();
                renderMarket(marketData);
            } catch(e) { document.getElementById('marketList').innerHTML='<div style="padding:20px;text-align:center">Erreur chargement</div>'; }
        }
        function renderMarket(data) {
            document.getElementById('marketList').innerHTML = data.map(i => `
                <div class="card list-item">
                    <img src="${i.image}" style="width:30px;border-radius:50%;margin-right:10px">
                    <div class="item-info"><b>${i.name}</b></div>
                    <div style="text-align:right">
                        <div>${fmt(i.current_price)}</div>
                        <div style="font-size:11px; color:${i.price_change_percentage_24h>=0?'#10b981':'red'}">${i.price_change_percentage_24h.toFixed(2)}%</div>
                    </div>
                </div>`).join('');
        }
        function filterMarket(t) { renderMarket(t=='all'?marketData:[]); }

        // --- GRAPHIQUES ---
        function updateStats() {
            const ctx = id('catChart');
            const cats = {}; state.transactions.filter(t=>t.type=='expense').forEach(t => cats[t.category] = (cats[t.category]||0)+t.amount);
            
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor:['#6366f1','#ef4444','#10b981','#f59e0b'] }]
                },
                options: { plugins: { legend: {position:'bottom'} } }
            });
        }

        // --- UTILITAIRES ---
        function id(i) { return document.getElementById(i); }
        function switchView(v, el) { 
            document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); id(v+'View').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(el) el.classList.add('active');
        }
        function openModal(m) { document.getElementById(m).classList.add('open'); }
        function closeModal(e,m) { if(!e || e.target.id==m) document.getElementById(m).classList.remove('open'); }
        
        function checkPremium() {
            if(state.isPremium) {
                document.querySelectorAll('.ad-box').forEach(e=>e.style.display='none');
                id('proBadge').style.display='inline-block';
                id('premiumBox').innerHTML='<h3 style="color:green">Compte PRO ‚úÖ</h3>';
            } else {
                document.querySelectorAll('.ad-box').forEach(e=>e.style.display='block');
                id('proBadge').style.display='none';
            }
        }
        function processPayment() { state.isPremium=true; save(); checkPremium(); closeModal(null,'modalPay'); toast('Bienvenue PRO !'); }
        function resetApp() { if(confirm('Tout effacer ?')){ localStorage.clear(); location.reload(); } }
        
        // --- IMPORT/EXPORT ---
        function exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const node = document.createElement('a'); node.setAttribute("href", str); node.setAttribute("download", "backup.json");
            document.body.appendChild(node); node.click(); node.remove();
        }
        function importData(e) {
            const reader = new FileReader();
            reader.onload = (event) => { try { state = JSON.parse(event.target.result); save(); toast('Import r√©ussi'); } catch(e) { alert('Erreur'); } };
            reader.readAsText(e.target.files[0]);
        }
        function processRecurring() { /* Simul√©: Dans une vraie app, v√©rifierait les dates */ }
        function changeCurrency(v) { state.currency=v; save(); }

    </script>
</body>
</html>
